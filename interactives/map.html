<!DOCTYPE html>
<meta charset="utf-8">
<title>Reservation Incomes</title>
<style>

.reservations {
	fill-opacity: .85;
}
.states {
  fill: #EAEAEA;
  stroke: #fff;
}
div.tooltip {   
 	position: absolute;           
	text-align: center;           
	width: 100px;                  
	padding: 2px;             
	font: 12px sans-serif;        
	background: white;   
	border: 0px;      
	border-radius: 8px;           
	pointer-events: none;         
}
svg {
	margin: 0 auto;
}
.rect {
	stroke: black;
}

</style>
<svg width="1200" height="650"></svg>
<script src="https://d3js.org/d3.v4.min.js"></script>
<script src="https://d3js.org/d3-scale-chromatic.v1.min.js"></script>
<script src="https://d3js.org/topojson.v2.min.js"></script>
<script src="https://d3js.org/d3-queue.v3.min.js"></script>

<script>

var svg = d3.select("svg")
    width = +svg.attr("width"),
    height = +svg.attr("height");

var div = d3.select("body")
    .append("div")   
	.attr("class", "tooltip")               
	.style("opacity", 0);    

var color_domain = [20000, 30000, 40000, 50000, 60000, 70000, 80000]
var ext_color_domain = [20000, 30000, 40000, 50000, 60000, 70000, 80000]
var legend_labels = ["< $20,000", "$20,000-$30,000", "$40,000-$50,000","$50,000-$60,000", "$60,000-$70,0000","$70,000-$80,000",">$80,000"]              
var mapColor = d3.scaleThreshold()
.domain(color_domain)
.range(d3.schemeRdBu[9]);


var projection = d3.geoAlbersUsa();
var path = d3.geoPath()
    .projection(projection);

var max_percent_change;

// var x = d3.scaleLinear()
//     .domain([2, 9])
//     .rangeRound([600, 860]);

// var mapColor = d3.scaleThreshold()
//     .domain(d3.range(2, 9))
//     .range(d3.schemePuBuGn[9]);

// var g = svg.append("g")
//     .attr("class", "key")
//     .attr("transform", "translate(0,24)");

// g.selectAll("rect")
//   .data(mapColor.range().map(function(d) {
//       d = mapColor.invertExtent(d);
//       if (d[0] == null) d[0] = x.domain()[0];
//       if (d[1] == null) d[1] = x.domain()[1];
//       return d;
//     }))
//   .enter().append("rect")
//     .attr("height", 8)
//     .attr("x", function(d) { return x(d[0]); })
//     .attr("width", function(d) { return x(d[1]) - x(d[0]); })
//     .attr("fill", function(d) { return mapColor(d[0]); });

// g.append("text")
//     .attr("class", "caption")
//     .attr("x", x.range()[0])
//     .attr("y", -4)
//     .attr("fill", "#000")
//     .attr("text-anchor", "start")
//     .attr("font-weight", "bold")
//     .text("Percent change in income");

// g.call(d3.axisBottom(x)
//     .tickSize(13)
//     .tickFormat(function(x, i) { return i ? x : x + "%"; })
//     .tickValues(mapColor.domain()))
//   .select(".domain")
//     .remove();

d3.json("geo/reservations.json", function(error, reservations) {
d3.json("geo/states_geo.json", function(us) {
  svg.append("path")
      .datum(topojson.feature(us, us.objects.states_geo))
      .attr("class", "states")
      .attr("d", path);

	console.log(reservations)
  if (error) throw error;

  svg.append("g")
      .attr("class", "reservations")
    .selectAll("path")
    .data(topojson.feature(reservations, reservations.objects.reservations).features)
    .enter().append("path")
      //.filter(function(d) { return +d.properties.percent_change !== undefined })
      .attr("d", path)
      .attr("fill", function(d) { 
        if (d.properties.median_household_income !== 0) {
          return mapColor(d.properties.median_household_income) ;
        }
        else {
          return "#ccc";
        }
      })
      .attr("stroke", "#8E8E8E")
      .attr("stroke-width", ".5px")
      .on("mousemove", function(d) {
		d3.select(this).style('fill-opacity', 1);   
    console.log(d.properties.median_household_income)         
    	div.transition()        
      	   .duration(100)      
           .style("opacity", .9);
           div.html("<b>" + d.properties.Geography+"</b> <br>" +  d3.format("($,.2f")(d.properties.median_household_income))
           .style("left", (d3.event.pageX) + "px")     
           .style("top", (d3.event.pageY - 28) + "px");    
	})   
    // fade out tooltip on mouse out               
    .on("mouseout", function(d) {  
    	d3.select(this).style('fill-opacity', .85);                 
        div.transition()        
           .duration(500)      
           .style("opacity", 0);   
    });
})
});

  var legend = svg.selectAll("g.legend")
  .data(ext_color_domain)
  .enter().append("g")
  .attr("transform", "translate(0,15)")
  .attr("class", "legend");

  var ls_w = 20, ls_h = 20;

  legend.append("rect")
  .attr("x", 20)
  .attr("y", function(d, i){ return height - (i*ls_h) - 1.75*ls_h;})
  .attr("width", ls_w)
  .attr("height", ls_h)
  .attr("class","rect")
  .style("fill", function(d, i) { return mapColor(d); })
  .style("opacity", 0.8);


  legend.append("text")
  .attr("x", 50)
  .attr("y", function(d, i){ return height - (i*ls_h) - ls_h - 1;})
  .text(function(d, i){ return legend_labels[i]; });

  legend.append("text")
  .attr("x", 20)
  .attr("y", 492)
  .text("Median Household Income");

</script>